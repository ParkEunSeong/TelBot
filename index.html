<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>TabCrusade</title>
  </head>
  <body style="text-align: center; padding: 0; margin: 0; overflow: hidden;">
    <canvas id="unity-canvas" width="383" height="690" tabindex="-1" style="background: rgb(4,128,255); position: fixed; top: 0; left: 0; width: 100%; height: 100%;">
	</canvas>
  <div id="container" class="container">
   <div class="text-overlay">TabCrusade</div>
    <img src="loading.gif" >
	 <div class="loading-text">Loading</div>
    </div>
	
    <script src="Build/Build.loader.js?v=1.0"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <style>
      * {
        scrollbar-width: thin;
        scrollbar-color: rgba(90, 90, 90, 0.3) transparent;
      }

      *::-webkit-scrollbar {
        width: 6px;
        height: 6px;
        background-color: transparent;
      }

      *::-webkit-scrollbar-thumb {
        border-radius: 6px;
        background-color: rgba(90, 90, 90, 0.3);
      }

      *::-webkit-scrollbar-corner {
        background-color: transparent;
      }

      #unity-logo {
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        max-width: 100%;
        height: auto;
      }

      #loading {
        position: absolute;
        bottom: 5%;
        left: 50%;
        transform: translateX(-50%);
        max-width: 85%;
        height: auto;
      }
		.container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .container img {
            width: 300px; /* 크기 조절 가능 */
            height: 300px;
            object-fit: cover;
        }
		 .text-overlay {
            position: absolute;
            top: 0%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            font-weight: bold;
            color: white;

            text-shadow: 
                -2px -2px 0 black,  
                 2px -2px 0 black,  
                -2px  2px 0 black,  
                 2px  2px 0 black; /* 윤곽선 효과 */
        }
		.loading-text::after {
            content: "."; /* 초기 상태 */
            animation: loadingDots 1.5s infinite steps(1);
        }

        @keyframes loadingDots {
            0% { content: "."; }
            25% { content: ".."; }
            50% { content: "..."; }
            75% { content: "."; }
            100% { content: ".."; }
        }

        .loading-text {
            font-size: 20px;
            font-weight: bold;
			color: white;
            margin-top: 10px;
        }
    </style>
    <script>
	  
        function hideLoadingMessage() {
      var loadingMessage = document.getElementById("container");
      if (loadingMessage) {
        loadingMessage.style.display = "none";
      }
    }
        var unityInstance = null;
            var unityCanvas = document.querySelector("#unity-canvas");
            let funnelData = null;
          if (Telegram) {
            // Telegram Web App 초기화
            function initTelegramWebApp() {
                // Telegram WebApp 초기화
                const tg = window.Telegram.WebApp;
                const AdController = window.Adsgram.init({ blockId: "5968", debug: true, debugBannerType:  "RewardedVideo"});
                // enableClosingConfirmation 설정 활성화
                tg.enableClosingConfirmation();
                tg.disableVerticalSwipes();

                // 닫기 이벤트 핸들러 설정
                tg.onEvent('closingConfirmation', function() {
                    console.log('Closing confirmation is enabled.');
                });

                tg.expand();
                
                // 미니앱 준비 완료
                tg.ready();
                console.log('tg ready');
            }

            window.addEventListener('load', initTelegramWebApp);
			
			  let initData = Telegram ? Telegram.WebApp.initData : null;
				if (initData) {
					try {
						const parsedInitData = new URLSearchParams(initData);
						const userJsonStr = parsedInitData.get('user');
						const user = JSON.parse(userJsonStr);
						const params = new URLSearchParams(window.location.search);
						let refCode = params.get('tgWebAppStartParam') ?? '';
						console.log(`refCode: ${refCode}`);
						funnelData = {
							id: Number(user.id), 
							username:user.username ?? '', 
							language_code:user.language_code ?? '', 
							is_premium:user.is_premium ?? false,
							ref_code: Number(refCode)
						};
						console.log('TelegramUser:', funnelData);
					} catch 
					{}
				} else {
					console.log('TelegramUser: null');
				}
        }


      
      
  // t.me/tabcrusadebot/game?startapp=ref_kBLmlXTbiM
        SetScreen();
      function SetScreen() {
        if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        var meta = document.createElement('meta');
        meta.name = 'viewport';
        meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
        document.head.appendChild(meta);

        var canvas = unityCanvas;
        canvas.style.width = "100%";
        canvas.style.height = "100%";
        canvas.style.position = "fixed";
        canvas.style.left = "0";
        canvas.style.top = "0";
        document.body.style.margin = "0";
        document.body.style.overflow = "hidden";

        if (Telegram.WebView) {
          Telegram.WebView.onEvent('viewport_changed', function (eventType, eventData) {
            const vp = window.visualViewport;
            if (eventData.is_state_stable) {
              if ((vp.height - vp.offsetTop) < eventData.height) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
                unityCanvas.style.width = "100%";
                unityCanvas.style.height = "100%";
                unityCanvas.style.position = "fixed";
              }
            }
          });
        }
      } else {
        function centerElement() {
          var originalWidth = 1080;
          var originalHeight = 2400;
          var aspectRatio = originalWidth / originalHeight;

          var windowWidth = window.innerWidth;
          var windowHeight = window.innerHeight;

          var canvas = unityCanvas;
          if (windowWidth / windowHeight > aspectRatio) {
            canvas.style.width = windowHeight * aspectRatio + "px";
            canvas.style.height = windowHeight + "px";
          } else {
            canvas.style.width = windowWidth + "px";
            canvas.style.height = windowWidth / aspectRatio + "px";
          }

          canvas.style.position = "fixed";
          canvas.style.top = "50%";
          canvas.style.left = "50%";
          canvas.style.transform = "translate(-50%, -50%)";
        }

        centerElement();
        window.addEventListener("resize", centerElement);
      }
      }
      CreateUnityInstance();
      function CreateUnityInstance() {
        setTimeout(function() {
        createUnityInstance(document.querySelector("#unity-canvas"), {
        dataUrl: "Build/Build.data",
        frameworkUrl: "Build/Build.framework.js",
        codeUrl: "Build/Build.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "TabCrusade",
          productVersion: "1.0",
        })
        .then((instance) => {
            // 성공적으로 인스턴스를 생성한 경우
            unityInstance = instance;
            console.log('init Unity ');
            if (unityInstance) {
                const strFunnel = JSON.stringify(funnelData)
                unityInstance.SendMessage('LoadingScene', 'OnReceivedUser', strFunnel);
            }
			  hideLoadingMessage(); 
        })
        .catch((error) => {
            // 인스턴스 생성 실패
            console.error("Failed to create Unity instance:", error);
        });
      }, 1000);
      }

      function ShowAd() {
        AdController.show().then((result) => {
                    // user watch ad till the end or close it in interstitial format
                    // your code to reward user for rewarded format
                    //alert('Reward');
					unityInstance.SendMessage('FloatingLayer', 'HandleReward');
                }).catch((result) => {
                    // user get error during playing ad
                    // do nothing or whatever you want
                    alert(JSON.stringify(result, null, 4));
                })
      }
    </script>
  </body>
</html>